# 東京ジオラマ (R3F) — プロフェッショナル配信計画書 (完全版)

> **目的**: React Three Fiber (R3F) を使用して、等角投影の音響豊富な東京ジオラマウェブサイトを構築するための完全なステップバイステップの青写真。この計画は小規模チーム（5-8人）向けに設計され、受け入れ基準、テスト計画、リスク管理を伴う明確にスコープされたフェーズで進めることで、動作する結果を保証します。

---

## 目次

1. [プロジェクトビジョンと非目標](#プロジェクトビジョンと非目標)
2. [ベースラインと技術スタック](#ベースラインと技術スタック)
3. [アーキテクチャ概要](#アーキテクチャ概要)
4. [データとアセットスキーマ](#データとアセットスキーマ)
5. [UXフローとUIコンポーネント](#uxフローとuiコンポーネント)
   - [ポップアップモーダル（仕様）](#ポップアップモーダル仕様)
6. [段階的ロードマップ（成果物付き）](#段階的ロードマップ成果物付き)
7. [作業分解構造（WBS）](#作業分解構造wbs)
8. [テスト戦略](#テスト戦略)
9. [パフォーマンス予算と最適化](#パフォーマンス予算と最適化)
10. [アクセシビリティと国際化](#アクセシビリティと国際化)
11. [DevOps、環境とデプロイメント](#devops環境とデプロイメント)
12. [リスク登録と軽減策](#リスク登録と軽減策)
13. [受け入れ基準（Go/No-Go）](#受け入れ基準gonogo)
14. [付録（コマンド、参考文献）](#付録コマンド参考文献)

---

## プロジェクトビジョンと非目標

**ビジョン**: ユーザーが象徴的なシーン（スカイツリー、東京タワー、渋谷スクランブル交差点など）を選択し、ピクセルスタイルのジオラマを探索し、レイヤードされたアンビエンスとSFXを聞くことができる、スムーズな等角投影の**東京サウンドスケープ**。最小限のUI摩擦とモバイルサポートを提供します。

**非目標**（スコープを現実的に保つため）:

- 完全なフォトリアリスティックPBRレンダリング
- プロシージャル都市生成
- MMO規模の群衆や物理シミュレーション
- 全シーンのオフラインPWA音声キャッシュ（後で改善可能）

**成功指標**:

- デスクトップでの初回コンテンツレンダリング < **1.5秒**、中程度のモバイルで < **3秒**
- TTI（インタラクティブ）< **3秒** デスクトップ / < **5秒** モバイル
- 60 FPS デスクトップ目標; ≥ 30 FPS モバイル
- シーン切り替え < **1.5秒** 体感（読み込み + 音声クロスフェード）

---

## ベースラインと技術スタック

**コア**

- React 19 + Next.js 15 (App Router / Turbopack)
- `@react-three/fiber` (R3F), `three`
- `@react-three/drei` ヘルパー
- Zustand (グローバル状態)
- Tailwind v4 (+ shadcn/ui コンポーネント、必要に応じて)

**このスタックを選ぶ理由**

- React 19の並行性 + サーバー機能（Next 15）で高速配信
- R3Fは宣言的3D + 堅牢なイベントシステムを提供
- Dreiはボイラープレートを削減（カメラ、ローダー、音声、環境）
- Zustandは軽量でシーンとUI状態に最適

**Node & パッケージマネージャー**

- Node ≥ 18
- `pnpm` 推奨

> **注意**: R3Fレンダリングはクライアントコンポーネントに保持し、サイドパネルUIは必要に応じてコンテンツ用にサーバーコンポーネントを活用できます。

---

## アーキテクチャ概要

```
tokyo-sounds/
├── .gitignore
├── components.json
├── eslint.config.mjs
├── next.config.ts
├── package-lock.json
├── package.json
├── pnpm-lock.yaml
├── pnpm-workspace.yaml
├── postcss.config.mjs
├── public/
│   ├── file.svg
│   ├── globe.svg
│   ├── next.svg
│   ├── vercel.svg
│   └── window.svg
├── README.md
├── src/
│   ├── app/
│   │   ├── favicon.ico
│   │   ├── globals.css
│   │   ├── layout.tsx
│   │   └── page.tsx
│   ├── components/
│   │   ├── layout/
│   │   │   ├── audio-player.tsx
│   │   │   ├── canvas.tsx
│   │   │   └── footer.tsx
│   │   └── ui/
│   │       ├── button.tsx
│   │       ├── input.tsx
│   │       ├── separator.tsx
│   │       ├── sheet.tsx
│   │       ├── sidebar.tsx
│   │       ├── skeleton.tsx
│   │       └── tooltip.tsx
│   ├── hooks/
│   │   └── use-mobile.ts
│   └── lib/
│       └── utils.ts
└── tsconfig.json

```

**レンダリングモデル**

- ピクセル正確な外観のための `<Canvas frameloop="demand" dpr={[1,1]} linear flat>`
- 等角投影回転の正射投影カメラ
- 最小限のライティング（環境光/半球光のみ）または完全にベイクされたライト
- 繰り返しプロップ用のインスタンシング
- マスター/アンビエンス/FXゲインを持つ音声グラフ

---

## データとアセットスキーマ

**`scenes.json`** (UIのシーンティルごとに1エントリ):

```json
[
  {
    "id": "skytree",
    "label": "TOKYO SKYTREE",
    "thumb": "/ui/thumbs/skytree.png",
    "focus": [5, 0, 5],
    "panOffset": [0, 0, 0],
    "models": [
      { "id": "skytree", "glb": "/models/skytree.glb", "pos": [5, 0, 5] },
      { "id": "shops", "glb": "/models/shops.glb", "pos": [0, 0, 0] }
    ],
    "instanced": {
      "trees": { "count": 120, "seed": 42, "area": [20, 0, 20] },
      "lamps": { "count": 45, "seed": 9, "area": [18, 0, 18] }
    },
    "audioPack": ["amb_city_day", "announcer_skytree"],
    "palette": "day",
    "weather": ["clear", "rain"],
    "timeOfDay": ["day", "night"]
  }
]
```

**`buildings.json`** (情報カード + モーダルコンテンツ):

```json
[
  {
    "id": "skytree",
    "title": "Tokyo Skytree",
    "facts": [
      { "label": "Height", "value": "634m" },
      { "label": "Opened", "value": "2012" },
      { "label": "Location", "value": "Sumida, Tokyo" }
    ],
    "description": "A television broadcasting tower and landmark.",
    "learnMoreUrl": "https://www.tokyo-skytree.jp/"
  }
]
```

**`sounds.json`** (バスルーティング):

```json
{
  "buses": ["master", "ambience", "fx"],
  "packs": {
    "amb_city_day": [
      {
        "url": "/audio/city_day_loop.mp3",
        "bus": "ambience",
        "loop": true,
        "gain": 0.7
      }
    ],
    "announcer_skytree": [
      {
        "url": "/audio/skytree_announcer.mp3",
        "bus": "fx",
        "loop": true,
        "gain": 0.4
      }
    ]
  }
}
```

**テクスチャ（ピクセル風）**

- PNG、最近傍フィルタリング、ミップマップなし、可能な限りアトラス化
- 寸法は2の累乗を推奨（512/1024）

---

## UXフローとUIコンポーネント

### 主要フロー

1. **ランディング** → ジオラマ + サイドパネルを表示
2. **ユーザーがシーンティルをクリック** → **シーンプレビューモーダル**が開く（下記参照）
3. **ユーザーが「シーンを読み込み」を確認** → モデルと音声パックを交換；モーダルを閉じる
4. **ユーザーが建物をクリック** → ハイライト + **建物情報モーダル**
5. **ユーザーが「体験を開始」を押す** → AudioContextを再開し、バスをミュート解除
6. 音量スライダーがマスターゲインをリアルタイムで調整

### コアコンポーネント

- **SidePanel**: ScenePicker、Volume、StartCTA、永続的な**InfoCard**エリアを保持
- **ScenePicker**: シーンティルのグリッド（サムネイルの遅延読み込み）
- **Volume**: 0-100のスライダー（[0-1]ゲインにマッピング）
- **StartCTA**: 目立つボタン；開始後は無効化
- **InfoCard**: 選択サマリーを表示；「詳細を見る」で**建物情報モーダル**を開く
- **Modals**（下記仕様参照）

---

## ポップアップモーダル（仕様）

### 1) `ScenePreviewModal`

**タイミング**: ユーザーがシーンティルをクリック  
**目的**: 誤クリックを減らし、重い読み込み前にコンテキストを提供

**コンテンツ**:

- タイトル + 短い説明
- サムネイルまたは小さなプレビュー（オプションのミニCanvas）
- コントロール:
  - プライマリ: **シーンを読み込み**（シーン切り替えと音声クロスフェードをトリガー）
  - セカンダリ: **キャンセル**
- オプションのトグル: 「読み込み後すぐに体験（音声）を開始」

**動作**:

- ティルクリックで**開く**
- **確認** → `setScene(sceneId)`を呼び出して閉じる；トグルがオンの場合、シーンが準備できた後に`resumeAudio()`を呼び出す
- **フォーカス管理**: フォーカスをトラップ；閉じる時にトリガーしたティルにフォーカスを戻す
- **キーボード**: `Enter` = 確認、`Esc` = 閉じる
- **ARIA**: `role="dialog"`、モーダルタイトルでラベル付け、`aria-modal="true"`
- **モバイル**: 大きなボタンを持つフルスクリーンシート

**状態**:

```ts
type ScenePreviewState = {
  open: boolean;
  sceneId?: string;
  startAudioAfterLoad: boolean;
};
```

### 2) `BuildingInfoModal`

**タイミング**: ユーザーがジオラマ内の建物をクリックまたは「詳細を見る」を押す  
**コンテンツ**:

- タイトル、画像（または静的レンダー）、事実リスト、説明、外部リンク
- コントロール: **閉じる**、**リンクを開く**（新しいタブで開く）  
  **動作**:
- 選択された建物のデータで**開く**；オーバーレイ/ESCで閉じる
- **フォーカス管理** + **ARIA**はプレビューモーダルと同一
- **モバイル**: スクロール可能なシート  
  **状態**:

```ts
type BuildingInfoState = {
  open: boolean;
  buildingId?: string;
};
```

**実装**:

- スタイリングにTailwindを使用したヘッドレスモーダル（例：shadcn/ui DialogまたはHeadless UI）を使用
- モーダルをCanvas内にレンダリング**しない**；React DOMに保持する

---

## 段階的ロードマップ（成果物付き）

### フェーズ0 — 基盤（✓ 完了済み）

**成果物**: リポジトリ、Next 15アプリ、lint/prettier、Tailwind、pnpm、ベースラインデブスクリプト

### フェーズ1 — コア3Dエンジン

- `frameloop="demand"`、`linear`、`flat`、`dpr={[1,1]}`で`<Canvas>`（クライアント）をセットアップ
- 正射投影**等角投影**カメラ（`IsoCamera`）
- 最小限のライト
- プレースホルダー地面 + 1つのテスト建物  
  **完了条件**: Canvasが一貫してレンダリングされ、`invalidate()`がインタラクションでのみ呼び出される

### フェーズ2 — アセットパイプライン

- GLBエクスポートルールを決定（スケール、軸、トライアングル数上限）
- GLB → 型付きコンポーネントに変換する`gltfjsx`コマンドを作成
- 2つのヒーロー建物（スカイツリー、109）を読み込み  
  **完了条件**: 両方が正しいマテリアルで読み込まれ、テクスチャが最近傍フィルタリングを使用

### フェーズ3 — インタラクション

- オクルージョンを制御する`e.stopPropagation()`でのポインターホバー/選択
- 選択をクリアする`onPointerMissed`  
  **完了条件**: ホバーハイライトとクリックで実際のデータで`BuildingInfoModal`が開く

### フェーズ4 — UIシステム

- ScenePicker、Volume、StartCTAを持つサイドパネル
- **`ScenePreviewModal`**フローを実装  
  **完了条件**: シーンをクリックするとモーダルが開き、確認するとシーンが読み込まれ、音声パックが更新される

### フェーズ5 — 動的ジオラマ

- テクスチャ/マテリアル交換による天気（晴れ/雨）、時間帯（昼/夜）
- インスタンス化プロップ（木/ランプ）
- オプション: スプライン上のアニメーション交通  
  **完了条件**: シーントグルがFPS低下なしで動作し、インスタンシングが確認される

### フェーズ6 — 音声体験

- 音声バス（マスター/アンビエンス/fx）
- シーンごとのパックとシーン変更時の**クロスフェード**
- AudioContextを再開するCTA  
  **完了条件**: CTA前に音声が再生されず、音量スライダーがマスターをリアルタイムで影響する

### フェーズ7 — 最適化

- メッシュ/マテリアル再利用
- テクスチャアトラス
- アニメーション時のみ条件付き`frameloop="always"`  
  **完了条件**: パフォーマンス予算が満たされる（下記参照）

### フェーズ8 — ポリッシュとリリース

- 進捗付きローディングスクリーン
- シーン切り替え時のカメラトゥイーン（フォーカスポイント）
- QA（モバイル/デスクトップ）、Vercelにデプロイ、最終コンテンツパス  
  **完了条件**: すべての受け入れ基準が満たされる

---

## 作業分解構造（WBS）

**1. プロジェクトセットアップ（0.5週）**  
1.1 リポジトリ、CI（lint、build）  
1.2 Tailwind & shadcn/ui インストール  
1.3 ルーティングスケルトン

**2. 3Dコア（1週）**  
2.1 CanvasRoot & IsoCamera  
2.2 地面プレーン + グリッド  
2.3 ライティングパス

**3. アセット（1週）**  
3.1 GLBエクスポートテンプレート、命名、単位  
3.2 `gltfjsx`スクリプト & ドキュメント  
3.3 2つのランドマークモデルをインポート

**4. インタラクション（0.5週）**  
4.1 ホバーハイライト、選択状態  
4.2 BuildingInfoModal（`buildings.json`からのコンテンツ）

**5. UIシステム（1週）**  
5.1 SidePanelレイアウト  
5.2 ScenePickerグリッド + ティル  
5.3 ScenePreviewModal（読み込み確認）

**6. 音声（0.5–1週）**  
6.1 バス & ゲインノード  
6.2 シーンごとのパック + クロスフェード  
6.3 StartCTA（ユーザージェスチャー）

**7. 動的ジオラマ（1週）**  
7.1 天気/時間トグル  
7.2 インスタンス化プロップ  
7.3 オプション交通

**8. パフォーマンス & QA（0.5–1週）**  
8.1 テクスチャアトラス + マテリアルマージ  
8.2 フレームループ戦略 + プロファイリング  
8.3 デバイスQA & 修正

**9. ポリッシュ & デプロイ（0.5週）**  
9.1 ローディングスクリーン  
9.2 カメラトゥイーン  
9.3 Vercelデプロイ

_合計: パートタイム約6–7週、フルタイム約3–4週_

---

## テスト戦略

**ユニット/ロジック**

- Zustandストア: アクション（`setScene`、`selectBuilding`、`setVolume`、モーダル開閉）
- ヘルパー（音声クロスフェード時間、インスタンス配置）

**コンポーネント**

- ScenePicker → クリックでScenePreviewModalを開く；確認で`setScene`をトリガー
- StartCTA → クリック時のみ音声を再開
- BuildingInfoModal → 正しい建物情報で開く；Esc/オーバーレイで閉じる

**E2E（Playwright）**

- 読み込み → 初回ペイント < 予算
- モーダル付きシーン切り替え → モデルを読み込み；音声クロスフェードが発生
- モバイルビューポート → モーダルがフルスクリーンシートに変換；フォーカストラップが動作
- キーボードa11y → `Enter`で確認、`Esc`で閉じる

**ビジュアルリグレッション**

- ピクセルスタイルには厳密な画像が必要：決定論的カメラを設定し、スクリーンショットを比較

---

## パフォーマンス予算と最適化

**予算**

- モデル: シーンあたり ≤ **50k tris**（理想的には15–30k）
- テクスチャ: シーンあたり合計 ≤ **10 MB**読み込み
- 音声: パックあたり ≤ **3 MB**（ループ、圧縮）

**レバー**

- `frameloop="demand"`；状態変更またはアニメーションループで`invalidate()`を呼び出し
- 木/ランプ用の**InstancedMesh**
- 最近傍フィルタリング；メモリ節約のためミップマップなし（ピクセル美学）
- 単一の指向性/環境光または完全にベイクされたテクスチャ
- 可能な限り描画コールをマージ（共有マテリアル）
- Suspenseチャンキングで非クリティカルモデルを遅延

---

## アクセシビリティと国際化

- **モーダル**: フォーカストラップ、ラベル付きタイトル、キーボードサポート、`aria-modal`
- ボタン: 見えるフォーカスリング（Tailwind）、大きなタップターゲット
- 音量スライダー: キーボード矢印 + スクリーンリーダーラベル
- 言語文字列: UIテキストを`locales/ja.json`と`locales/en.json`に抽出して将来のi18nに対応

---

## DevOps、環境とデプロイメント

- **環境**: dev（ローカル）、preview（PRデプロイ）、prod（main）
- **プレビューURL**を各マイルストーン後にステークホルダーに提供
- **デプロイメント**: 静的アセット配信付きVercel（`/public`内のモデル、テクスチャ、音声）
- **CI**: ESLint + 型チェック + Playwrightスモーク

---

## リスク登録と軽減策

| リスク                       |   影響 | 可能性 | 軽減策                                      |
| -------------------------- | -------: | :--------: | ----------------------------------------------- |
| モデルが重すぎる           | FPS低下 |    中     | トライ予算を強制し、PRごとにGLBをレビュー          |
| 音声自動再生がブロック     | 音なし |    高    | StartCTAでゲート；クリックでAudioContextを再開 |
| モバイルメモリ制限         |  クラッシュ |    低     | パックを遅延読み込み；同時音声ソースを制限   |
| ピッキングエラー（オクルージョン） |  UXバグ |    中     | `stopPropagation`を使用；大きな地面キャッチメッシュ  |
| チームがR3Fに不慣れ       |   遅延 |    中     | Canvasを最小限に保ち、Dreiを使用、コードドキュメントを追加    |

---

## 受け入れ基準（Go/No-Go）

- ✅ シーンが**ScenePreviewModal**経由で選択可能；確認で予算内で読み込み
- ✅ 建物をクリックすると正しい情報とディープリンクで**BuildingInfoModal**が開く
- ✅ 音声にはStartCTAが必要；音量スライダーが動作
- ✅ 中程度のハードウェアでデスクトップ60fps / モバイル30fps
- ✅ すべてのE2Eテストがパス；モーダルとスライダーのa11yチェックがパス

---

## 付録（コマンド、参考文献）

### インストール（pnpm）

```bash
pnpm add three @react-three/fiber @react-three/drei zustand
pnpm add -D @types/three
```

### スクリプト: GLTF → JSX（開発支援）

```bash
# GLBからコンポーネントを生成
npx gltfjsx ./public/models/skytree.glb --transform --types
```

### 状態形状（Zustand）

```ts
type SceneId = "skytree" | "tower" | "crossing" | string;
type AppState = {
  sceneId: SceneId;
  isStarted: boolean;
  selection?: string | null;
  hoverId?: string | null;
  volume: number; // 0..1
  modals: {
    scenePreview: {
      open: boolean;
      sceneId?: SceneId;
      startAudioAfterLoad: boolean;
    };
    buildingInfo: { open: boolean; buildingId?: string };
  };
};
```

### モーダルトリガー（イベント → アクション）

- シーンティルクリック → `openScenePreview(sceneId)`
- モーダルで確認 → `setScene(sceneId)` → `closeScenePreview()`
- 建物クリック → `openBuildingInfo(buildingId)`
- 「詳細を見る」 → 外部リンク（新しいタブ）

---

**この計画は意図的に「コード軽量」で「プロセス重視」です。** 必要に応じて、上記の各コンポーネント用の空ファイルとTODOコメントを持つ**スターターリポジトリ**を生成し、偽のシーンに接続されたモーダルを追加して、チームが1日目にすべてをクリックして確認できるようにする次のステップがあります。
